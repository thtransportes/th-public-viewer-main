<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador TH Transportes</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
    <link rel="stylesheet" href="visualizador-anexos.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="/img/LOGO TH PRETO.png" alt="Logo TH Transportes">
            <h1 id="service-code">Carregando...</h1>
            <p id="page-subtitle">Visualizador</p>
        </header>
        <main>
            <div id="loading">Carregando dados, por favor aguarde...</div>
            <div id="not-found" style="display: none;"></div>
            
            <!-- Container da Galeria (Fotos/VÃ­deos) -->
            <div id="gallery"></div>

            <!-- NOVO: Container da Lista de Materiais -->
            <div id="material-list" style="display: none;">
                <div class="progress-container">
                    <div class="progress-text">Progresso: <span id="progress-count">0/0</span></div>
                    <div class="progress-bar"><div id="progress-fill" style="width: 0%"></div></div>
                </div>
                <ul id="checklist-items"></ul>
                <div id="success-msg" class="success-banner" style="display: none;">
                    âœ… Todos os itens conferidos!
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Elementos DOM
        const els = {
            gallery: document.getElementById('gallery'),
            materialList: document.getElementById('material-list'),
            checklistItems: document.getElementById('checklist-items'),
            loading: document.getElementById('loading'),
            notFound: document.getElementById('not-found'),
            title: document.getElementById('service-code'),
            subtitle: document.getElementById('page-subtitle'),
            progressFill: document.getElementById('progress-fill'),
            progressCount: document.getElementById('progress-count'),
            successMsg: document.getElementById('success-msg')
        };

        const workerUrl = 'https://erp-link-resolver.thtransportes021.workers.dev';

        try {
            const key = window.location.hash.substring(1);
            if (!key) throw new Error('Link invÃ¡lido. ID nÃ£o encontrado.');

            const response = await fetch(`${workerUrl}?id=${key}`);
            if (!response.ok) throw new Error('Link expirado ou nÃ£o encontrado.');
            
            const data = await response.json();
            
            if (!data) throw new Error('Dados invÃ¡lidos.');

            // Atualiza cabeÃ§alho comum
            els.title.textContent = data.titulo || `ServiÃ§o ${data.codigo_projeto}`;
            els.subtitle.textContent = data.subtitulo || (data.tipo === 'materiais' ? 'Lista de SeparaÃ§Ã£o' : 'Galeria de Anexos');
            els.loading.style.display = 'none';

            // === LÃ“GICA DE DECISÃƒO ===
            
            // CASO 1: Ã‰ UMA LISTA DE MATERIAIS?
            if (data.tipo === 'materiais' && data.itens) {
                renderMaterialList(data.itens);
            } 
            // CASO 2: Ã‰ UMA GALERIA DE ARQUIVOS?
            else if (data.files && data.files.length > 0) {
                renderGallery(data);
            } 
            // CASO 3: VAZIO OU ERRO
            else {
                throw new Error('Nenhum conteÃºdo disponÃ­vel neste link.');
            }

        } catch (error) {
            console.error("Erro:", error);
            els.loading.style.display = 'none';
            els.title.textContent = 'Erro';
            els.notFound.textContent = error.message;
            els.notFound.style.display = 'block';
        }

        // --- FUNÃ‡ÃƒO PARA RENDERIZAR LISTA DE MATERIAIS ---
        function renderMaterialList(itens) {
            els.materialList.style.display = 'block';
            els.gallery.style.display = 'none';

            let checkedCount = 0;
            const total = itens.length;

            const updateProgress = () => {
                const pct = Math.round((checkedCount / total) * 100);
                els.progressFill.style.width = `${pct}%`;
                els.progressCount.textContent = `${checkedCount}/${total}`;
                
                if (checkedCount === total) {
                    els.successMsg.style.display = 'block';
                    // Efeito de confete ou som poderia vir aqui
                } else {
                    els.successMsg.style.display = 'none';
                }
            };

            updateProgress(); // Inicializa

            itens.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'check-item';
                li.innerHTML = `
                    <div class="checkbox-custom">âœ”</div>
                    <div class="item-data">
                        <span class="qty">${item.qtd} ${item.unidade || 'un'}</span>
                        <span class="name">${item.nome}</span>
                    </div>
                `;

                // Evento de Click (Toggle)
                li.addEventListener('click', () => {
                    li.classList.toggle('checked');
                    if (li.classList.contains('checked')) {
                        checkedCount++;
                    } else {
                        checkedCount--;
                    }
                    updateProgress();
                });

                els.checklistItems.appendChild(li);
            });
        }

        // --- FUNÃ‡ÃƒO PARA RENDERIZAR GALERIA (Seu cÃ³digo original refatorado) ---
        function renderGallery(data) {
            els.gallery.style.display = 'grid';
            els.materialList.style.display = 'none';

            data.files.forEach(file => {
                const fileUrl = `${data.publicR2Url}/${file.url}`;
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);
                const isVideo = /\.(mp4|webm|ogg)$/i.test(file.name);
                const isMedia = isImage || isVideo;

                const card = document.createElement('a');
                card.href = fileUrl;
                card.className = 'file-card glightbox';
                card.setAttribute('data-gallery', 'project-gallery');
                
                if (!isMedia) {
                    card.classList.remove('glightbox');
                    card.target = '_blank';
                }

                let thumbContent = `<div class="icon">ðŸ“„</div>`;
                if (isImage) thumbContent = `<img src="${fileUrl}" loading="lazy">`;
                if (isVideo) thumbContent = `<div class="icon-background"><div class="play-icon">â–¶</div></div>`;

                card.innerHTML = `
                    <div class="thumbnail">${thumbContent}</div>
                    <div class="file-info">
                        <strong>${file.name}</strong>
                        <span class="badge" data-category="${file.category}">${file.category}</span>
                    </div>
                `;
                els.gallery.appendChild(card);
            });

            GLightbox({ selector: '.glightbox' });
        }
    });
    </script>
</body>
</html>
